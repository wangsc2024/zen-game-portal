<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ­£å¿µè¨˜æ†¶ - Mindful Memory</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #e8e8e8;
        }

        h1 {
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            margin-bottom: 10px;
            background: linear-gradient(90deg, #f7d794, #f8b739);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(248, 183, 57, 0.3);
        }

        .subtitle {
            font-size: clamp(0.8rem, 2vw, 1rem);
            color: #a0a0a0;
            margin-bottom: 20px;
            text-align: center;
        }

        .game-info {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
        }

        .info-label {
            font-size: 0.8rem;
            color: #a0a0a0;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f7d794;
        }

        #game-container {
            display: grid;
            gap: 10px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .card {
            width: clamp(60px, 15vw, 90px);
            height: clamp(80px, 20vw, 120px);
            background: linear-gradient(145deg, #3d5a80, #293241);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            transform-style: preserve-3d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .card:hover:not(.flipped):not(.matched) {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(247, 215, 148, 0.3);
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card.matched {
            background: linear-gradient(145deg, #2d6a4f, #1b4332);
            box-shadow: 0 0 20px rgba(45, 106, 79, 0.5);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            border-radius: 10px;
        }

        .card-back {
            background: linear-gradient(145deg, #3d5a80, #293241);
        }

        .card-back::before {
            content: 'â˜¸';
            font-size: clamp(1.5rem, 4vw, 2rem);
            color: rgba(247, 215, 148, 0.5);
        }

        .card-front {
            background: linear-gradient(145deg, #4a6fa5, #354f6f);
            transform: rotateY(180deg);
            flex-direction: column;
            padding: 5px;
        }

        .card-symbol {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
        }

        .card-text {
            font-size: clamp(0.5rem, 1.5vw, 0.7rem);
            color: #f7d794;
            margin-top: 5px;
            text-align: center;
        }

        .message {
            margin-top: 20px;
            font-size: 1.2rem;
            min-height: 30px;
            text-align: center;
            color: #a0a0a0;
            font-style: italic;
        }

        .message.success {
            color: #4ade80;
            animation: glow 1s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
            to { text-shadow: 0 0 20px rgba(74, 222, 128, 0.8); }
        }

        .btn {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 1rem;
            background: linear-gradient(145deg, #f8b739, #f7d794);
            border: none;
            border-radius: 25px;
            color: #1a1a2e;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(248, 183, 57, 0.4);
        }

        .instructions {
            max-width: 600px;
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .instructions h3 {
            color: #f7d794;
            margin-bottom: 10px;
        }

        .eightfold-path {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .path-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            font-size: 0.8rem;
        }

        .path-item span {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        /* æˆå°±é€šçŸ¥æ¨£å¼ */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: -300px;
            background: linear-gradient(135deg, #293241 0%, #1a1a2e 100%);
            border: 1px solid #f7d794;
            border-radius: 12px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 200;
            transition: right 0.5s ease;
        }

        .achievement-notification.show {
            right: 20px;
        }

        .ach-icon {
            font-size: 2rem;
        }

        .ach-content {
            text-align: left;
        }

        .ach-title {
            font-size: 0.9rem;
            color: #f7d794;
            font-weight: bold;
        }

        .ach-desc {
            font-size: 0.75rem;
            color: #a0a0a0;
            margin-top: 2px;
        }

        /* Streak æ–·è£‚å®‰æ…°è¨Šæ¯ */
        .streak-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #293241 0%, #1a1a2e 100%);
            border: 1px solid #f7d794;
            border-radius: 15px;
            padding: 25px 35px;
            text-align: center;
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            max-width: 340px;
        }

        .streak-message.show {
            opacity: 1;
            pointer-events: auto;
        }

        .streak-message h3 {
            color: #f7d794;
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
        }

        .streak-message p {
            color: #a0a0a0;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 0.8rem;
        }

        .streak-message .encouragement {
            color: #4ade80;
            font-style: italic;
            font-size: 0.9rem;
        }

        .streak-message .close-btn {
            background: linear-gradient(145deg, #f8b739, #f7d794);
            border: none;
            color: #1a1a2e;
            padding: 10px 24px;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 1rem;
            transition: transform 0.2s ease;
        }

        .streak-message .close-btn:hover {
            transform: scale(1.05);
        }

        /* ç¿’æ…£å †ç–Šå»ºè­° */
        .habit-stack-tip {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2d6a4f 0%, #1b4332 100%);
            border: 1px solid #4ade80;
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            z-index: 180;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
            max-width: 90vw;
        }

        .habit-stack-tip.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(-50%) translateY(0);
        }

        .habit-stack-tip .tip-icon {
            font-size: 1.5rem;
        }

        .habit-stack-tip .tip-content {
            text-align: left;
        }

        .habit-stack-tip .tip-title {
            font-size: 0.85rem;
            color: #4ade80;
            font-weight: bold;
        }

        .habit-stack-tip .tip-desc {
            font-size: 0.75rem;
            color: #a0a0a0;
            margin-top: 2px;
        }

        .habit-stack-tip .close-tip {
            background: transparent;
            border: none;
            color: #a0a0a0;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s;
        }

        .habit-stack-tip .close-tip:hover {
            color: #f7d794;
        }

        /* éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ• */
        .sound-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(247, 215, 148, 0.3);
            color: #f7d794;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s, transform 0.2s;
            z-index: 100;
            -webkit-tap-highlight-color: transparent;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .sound-toggle.muted {
            color: #666;
            border-color: rgba(102, 102, 102, 0.3);
        }

        /* è¿”å›é€£çµ */
        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            color: #a0a0a0;
            text-decoration: none;
            font-size: 0.9rem;
            z-index: 300;
            transition: color 0.3s ease;
        }
        .back-link:hover { color: #f7d794; }

        /* æš«åœè¦†è“‹å±¤ */
        .pause-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 26, 46, 0.85);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 250;
            animation: fadeIn 0.2s ease;
        }
        .pause-overlay h2 {
            font-size: 2rem; color: #f7d794; margin-bottom: 1rem;
        }
        .pause-overlay p {
            color: #a0a0a0; margin-bottom: 1.5rem;
        }
        @keyframes fadeInPause {
            from { opacity: 0; } to { opacity: 1; }
        }
    </style>
</head>
<body>
    <a href="../" class="back-link">â† è¿”å›éŠå»Š</a>
    <button class="sound-toggle" id="soundToggle" title="éŸ³æ•ˆé–‹é—œ">ğŸ””</button>
    <h1>â˜¸ æ­£å¿µè¨˜æ†¶</h1>
    <p class="subtitle">é€éé…å°å…«æ­£é“ï¼ŒåŸ¹é¤Šå°ˆæ³¨èˆ‡è¦ºå¯Ÿ</p>

    <div class="game-info">
        <div class="info-item">
            <div class="info-label">ç¿»ç‰Œæ¬¡æ•¸</div>
            <div class="info-value" id="moves">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">é…å°æˆåŠŸ</div>
            <div class="info-value" id="matches">0 / 8</div>
        </div>
        <div class="info-item">
            <div class="info-label">æ™‚é–“</div>
            <div class="info-value" id="timer">00:00</div>
        </div>
        <div class="info-item">
            <div class="info-label">é€£çºŒå¤©æ•¸</div>
            <div class="info-value" id="streakDisplay">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">æœ€ä½³ç´€éŒ„</div>
            <div class="info-value" id="bestDisplay">-</div>
        </div>
    </div>

    <div id="game-container"></div>

    <p class="message" id="message">ç¿»é–‹å¡ç‰‡ï¼Œæ‰¾å‡ºæˆå°çš„å…«æ­£é“</p>

    <button class="btn" id="restart-btn">é‡æ–°é–‹å§‹</button>

    <div class="instructions">
        <h3>ğŸ§˜ éŠæˆ²èªªæ˜</h3>
        <p>
            ç¿»é–‹å¡ç‰‡ï¼Œæ‰¾å‡ºé…å°çš„å…«æ­£é“ç¬¦è™Ÿã€‚æ¯æ¬¡åªèƒ½ç¿»é–‹å…©å¼µå¡ç‰‡ï¼Œ
            è‹¥ç¬¦è™Ÿç›¸åŒå‰‡é…å°æˆåŠŸã€‚ç”¨æœ€å°‘çš„ç¿»ç‰Œæ¬¡æ•¸å®Œæˆæ‰€æœ‰é…å°ã€‚
        </p>
        <p style="margin-top: 10px; color: #a0a0a0;">
            å…«æ­£é“æ˜¯ä½›é™€æ•™å°çš„è§£è„«ä¹‹é“ï¼Œåœ¨éŠæˆ²ä¸­å°ˆæ³¨è§€å¯Ÿï¼ŒåŸ¹é¤Šæ­£å¿µè¦ºçŸ¥ã€‚
        </p>
        <h3 style="margin-top: 15px;">å…«æ­£é“</h3>
        <div class="eightfold-path">
            <div class="path-item"><span>ğŸ‘ï¸</span>æ­£è¦‹</div>
            <div class="path-item"><span>ğŸ’­</span>æ­£æ€æƒŸ</div>
            <div class="path-item"><span>ğŸ’¬</span>æ­£èª</div>
            <div class="path-item"><span>ğŸ™</span>æ­£æ¥­</div>
            <div class="path-item"><span>âš–ï¸</span>æ­£å‘½</div>
            <div class="path-item"><span>ğŸ’ª</span>æ­£ç²¾é€²</div>
            <div class="path-item"><span>ğŸ§˜</span>æ­£å¿µ</div>
            <div class="path-item"><span>ğŸŒ¸</span>æ­£å®š</div>
        </div>
    </div>

    <!-- Streak æ–·è£‚å®‰æ…°è¨Šæ¯ -->
    <div class="streak-message" id="streakMessage">
        <h3>ğŸ™ æ­¡è¿å›ä¾†</h3>
        <p>é€£çºŒå¤©æ•¸å·²é‡ç½®ï¼Œä½†é€™æ²’é—œä¿‚ã€‚</p>
        <p class="encouragement">ã€Œæ¯ä¸€åˆ»è¦ºå¯Ÿï¼Œéƒ½æ˜¯æ–°çš„é–‹å§‹ã€‚ã€</p>
        <button class="close-btn" id="closeStreakMsg">ç¹¼çºŒç·´ç¿’</button>
    </div>

    <!-- ç¿’æ…£å †ç–Šå»ºè­° -->
    <div class="habit-stack-tip" id="habitStackTip">
        <div class="tip-icon">ğŸ’¡</div>
        <div class="tip-content">
            <div class="tip-title">ç¿’æ…£å †ç–Šå°æŠ€å·§</div>
            <div class="tip-desc" id="habitTipText">è©¦è‘—åœ¨æ¯å¤©å–å®Œå’–å•¡å¾Œä¾†ä¸€å±€ï¼</div>
        </div>
        <button class="close-tip" id="closeHabitTip">Ã—</button>
    </div>

    <script>
        // === å†¥æƒ³éŸ³æ•ˆç³»çµ±ï¼ˆWeb Audio APIï¼‰===
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        let soundEnabled = localStorage.getItem('mindful_sound') !== 'off';

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioCtx();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ•
        const soundToggleBtn = document.getElementById('soundToggle');
        function updateSoundButton() {
            soundToggleBtn.textContent = soundEnabled ? 'ğŸ””' : 'ğŸ”•';
            soundToggleBtn.classList.toggle('muted', !soundEnabled);
        }
        updateSoundButton();
        soundToggleBtn.addEventListener('click', () => {
            initAudio();
            soundEnabled = !soundEnabled;
            localStorage.setItem('mindful_sound', soundEnabled ? 'on' : 'off');
            updateSoundButton();
            if (soundEnabled) playFlipSound(); // æ’­æ”¾ç¢ºèªéŸ³
        });

        // é Œç¼½éŸ³æ•ˆ â€” é‡‘å±¬å…±é³´æ³›éŸ³
        function playSingingBowl(baseFreq, duration, volume = 0.15) {
            if (!soundEnabled || !audioCtx) return;
            const now = audioCtx.currentTime;
            // åŸºé » + æ³›éŸ³æ¨¡æ“¬é Œç¼½å…±æŒ¯
            const harmonics = [1, 2.76, 4.72];
            const volumes = [volume, volume * 0.4, volume * 0.15];
            harmonics.forEach((h, i) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = baseFreq * h;
                gain.gain.setValueAtTime(volumes[i], now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + duration);
            });
        }

        // ç¿»ç‰ŒéŸ³æ•ˆ â€” è¼•æŸ”çŸ­ä¿ƒ
        function playFlipSound() {
            if (!soundEnabled || !audioCtx) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.04);
            gain.gain.setValueAtTime(0.08, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + 0.1);
        }

        // é…å°æˆåŠŸéŸ³æ•ˆ â€” é Œç¼½ï¼ˆéŸ³é«˜éš¨é…å°æ•¸æ¼¸é€²ï¼‰
        function playMatchSound(pairIndex) {
            if (!soundEnabled || !audioCtx) return;
            // å¾ C4 åˆ° C5 æ¼¸é€²ï¼ˆæ¯å°å‡ä¸€å€‹éŸ³éšï¼‰
            const scale = [262, 294, 330, 349, 392, 440, 494, 523];
            const freq = scale[Math.min(pairIndex, scale.length - 1)];
            playSingingBowl(freq, 1.8, 0.12);
        }

        // é…å°å¤±æ•—éŸ³æ•ˆ â€” ä½æ²‰æœ¨é­šè²
        function playMismatchSound() {
            if (!soundEnabled || !audioCtx) return;
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(180, now);
            osc.frequency.exponentialRampToValueAtTime(120, now + 0.15);
            gain.gain.setValueAtTime(0.1, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + 0.35);
        }

        // éŠæˆ²å®ŒæˆéŸ³æ•ˆ â€” é Œç¼½å’Œå¼¦ï¼ˆCå¤§ä¸‰å’Œå¼¦å±•é–‹ï¼‰
        function playCompletionSound() {
            if (!soundEnabled || !audioCtx) return;
            // C4 â†’ E4 â†’ G4 â†’ C5 ä¾åºéŸ¿èµ·ï¼Œå½¢æˆå’Œå¼¦
            const notes = [
                { freq: 262, delay: 0, duration: 3.0 },
                { freq: 330, delay: 0.3, duration: 2.7 },
                { freq: 392, delay: 0.6, duration: 2.4 },
                { freq: 523, delay: 1.0, duration: 2.0 }
            ];
            notes.forEach(n => {
                setTimeout(() => playSingingBowl(n.freq, n.duration, 0.1), n.delay * 1000);
            });
            // æœ€å¾ŒåŠ ä¸Šéˆ´è²
            setTimeout(() => {
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = 2093; // C7 é«˜äº®éˆ´è²
                gain.gain.setValueAtTime(0.06, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 1.5);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + 1.6);
            }, 1500);
        }

        // æˆå°±è§£é–éŸ³æ•ˆ â€” æ¸…è„†éˆ´è²ä¸‰é€£
        function playAchievementSound() {
            if (!soundEnabled || !audioCtx) return;
            const notes = [784, 988, 1319]; // G5 â†’ B5 â†’ E6
            notes.forEach((freq, i) => {
                setTimeout(() => {
                    const now = audioCtx.currentTime;
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq;
                    gain.gain.setValueAtTime(0.08, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.4);
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.start(now);
                    osc.stop(now + 0.45);
                }, i * 150);
            });
        }

        // å…«æ­£é“å¡ç‰‡è³‡æ–™
        const eightfoldPath = [
            { symbol: 'ğŸ‘ï¸', name: 'æ­£è¦‹' },
            { symbol: 'ğŸ’­', name: 'æ­£æ€æƒŸ' },
            { symbol: 'ğŸ’¬', name: 'æ­£èª' },
            { symbol: 'ğŸ™', name: 'æ­£æ¥­' },
            { symbol: 'âš–ï¸', name: 'æ­£å‘½' },
            { symbol: 'ğŸ’ª', name: 'æ­£ç²¾é€²' },
            { symbol: 'ğŸ§˜', name: 'æ­£å¿µ' },
            { symbol: 'ğŸŒ¸', name: 'æ­£å®š' }
        ];

        // é€²åº¦æŒä¹…åŒ–å¸¸æ•¸
        const STORAGE_KEY = 'mindful_memory_progress';

        // æˆå°±å®šç¾©
        const ACHIEVEMENTS = [
            { id: 'first_win', name: 'åˆè­˜å…«æ­£é“', desc: 'é¦–æ¬¡å®ŒæˆéŠæˆ²', requirement: 1 },
            { id: 'perfect_16', name: 'å®Œç¾è¨˜æ†¶', desc: 'ç”¨ 16 æ¬¡æˆ–æ›´å°‘ç¿»ç‰Œå®Œæˆ', requirement: 16, type: 'moves' },
            { id: 'speed_60', name: 'å°ˆæ³¨å¦‚ä¸€', desc: '60 ç§’å…§å®Œæˆ', requirement: 60, type: 'time' },
            { id: 'streak_3', name: 'æŒä¹‹ä»¥æ†', desc: 'é€£çºŒ 3 å¤©ç·´ç¿’', requirement: 3, type: 'streak' },
            { id: 'streak_7', name: 'ä¸ƒæ—¥ç²¾é€²', desc: 'é€£çºŒ 7 å¤©ç·´ç¿’', requirement: 7, type: 'streak' },
            { id: 'total_10', name: 'åæ¬¡ä¿®è¡Œ', desc: 'ç´¯è¨ˆå®Œæˆ 10 æ¬¡', requirement: 10, type: 'total' },
            { id: 'total_50', name: 'äº”åæ¬¡åœ“æ»¿', desc: 'ç´¯è¨ˆå®Œæˆ 50 æ¬¡', requirement: 50, type: 'total' }
        ];

        // éŠæˆ²ç‹€æ…‹
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let gameStarted = false;
        let timerInterval = null;
        let seconds = 0;
        let isProcessing = false;

        // é€²åº¦è¿½è¹¤
        let progress = {
            totalGames: 0,
            streak: 0,
            lastPlayDate: null,
            achievements: [],
            bestMoves: Infinity,
            bestTime: Infinity
        };

        // DOM å…ƒç´ 
        const gameContainer = document.getElementById('game-container');
        const movesDisplay = document.getElementById('moves');
        const matchesDisplay = document.getElementById('matches');
        const timerDisplay = document.getElementById('timer');
        const messageDisplay = document.getElementById('message');
        const restartBtn = document.getElementById('restart-btn');

        // === é€²åº¦æŒä¹…åŒ– ===
        function loadProgress() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    progress = JSON.parse(saved);
                    if (progress.bestMoves === null) progress.bestMoves = Infinity;
                    if (progress.bestTime === null) progress.bestTime = Infinity;
                }
            } catch (e) {
                console.warn('ç„¡æ³•è¼‰å…¥é€²åº¦', e);
            }
        }

        function saveProgress() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
            } catch (e) {
                console.warn('ç„¡æ³•å„²å­˜é€²åº¦', e);
            }
        }

        // ç¿’æ…£å †ç–Šå»ºè­°åº«
        const HABIT_STACK_TIPS = [
            'è©¦è‘—åœ¨æ¯å¤©å–å®Œå’–å•¡å¾Œä¾†ä¸€å±€ï¼',
            'åˆä¼‘å‰ç©ä¸€å±€ï¼Œç‚ºä¸‹åˆæç¥ã€‚',
            'ç¡å‰ç©ä¸€å±€ï¼Œè®“å¿ƒéœä¸‹ä¾†ã€‚',
            'æ—©é¤å¾Œä¾†ä¸€å±€ï¼Œé–‹å•Ÿå°ˆæ³¨çš„ä¸€å¤©ã€‚',
            'æ¯å¤©å›ºå®šæ™‚é–“ç©ï¼Œæ›´å®¹æ˜“é¤Šæˆç¿’æ…£ã€‚',
            'æŠŠéŠæˆ²åœ–ç¤ºæ”¾åœ¨æ‰‹æ©Ÿé¦–é ï¼Œéš¨æ™‚æé†’è‡ªå·±ã€‚'
        ];

        // === é€£çºŒå¤©æ•¸è¿½è¹¤ ===
        function getDateString() {
            const d = new Date();
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        }

        function getDaysDiff(date1, date2) {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
        }

        function updateStreakOnLoad() {
            const today = getDateString();
            const lastPlay = progress.lastPlayDate;
            if (!lastPlay) return false;
            const daysDiff = getDaysDiff(lastPlay, today);
            if (daysDiff > 1) {
                const previousStreak = progress.streak;
                progress.streak = 0;
                saveProgress();
                // åªæœ‰ä¹‹å‰æœ‰é€£çºŒç´€éŒ„æ‰é¡¯ç¤ºå®‰æ…°è¨Šæ¯
                return previousStreak >= 2;
            }
            return false;
        }

        // === Streak å®‰æ…°è¨Šæ¯ï¼ˆçµ•ä¸éŒ¯éå…©æ¬¡åŸå‰‡ï¼‰===
        function showStreakBrokenMessage() {
            const streakMessage = document.getElementById('streakMessage');
            const closeBtn = document.getElementById('closeStreakMsg');
            if (streakMessage) {
                // éš¨æ©Ÿé¸æ“‡ä¸€å‰‡å®‰æ…°èª
                const encouragements = [
                    'ã€Œæ¯ä¸€åˆ»è¦ºå¯Ÿï¼Œéƒ½æ˜¯æ–°çš„é–‹å§‹ã€‚ã€',
                    'ã€Œæ”¾ä¸‹éå»ï¼Œæ´»åœ¨ç•¶ä¸‹ã€‚ã€',
                    'ã€Œé‡æ–°é–‹å§‹ï¼Œä¹Ÿæ˜¯æ­£ç²¾é€²ã€‚ã€',
                    'ã€Œå¿ƒç„¡ç½£ç¤™ï¼Œè‡ªåœ¨å‰è¡Œã€‚ã€'
                ];
                const randomMsg = encouragements[Math.floor(Math.random() * encouragements.length)];
                const encouragementEl = streakMessage.querySelector('.encouragement');
                if (encouragementEl) {
                    encouragementEl.textContent = randomMsg;
                }
                streakMessage.classList.add('show');
            }
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    streakMessage.classList.remove('show');
                }, { once: true });
            }
        }

        // === ç¿’æ…£å †ç–Šå»ºè­°ï¼ˆç¿’æ…£å †ç–ŠåŸå‰‡ï¼‰===
        function showHabitStackTip() {
            const habitTip = document.getElementById('habitStackTip');
            const tipText = document.getElementById('habitTipText');
            const closeBtn = document.getElementById('closeHabitTip');

            if (habitTip && tipText) {
                // éš¨æ©Ÿé¸æ“‡ä¸€å‰‡å»ºè­°
                const randomTip = HABIT_STACK_TIPS[Math.floor(Math.random() * HABIT_STACK_TIPS.length)];
                tipText.textContent = randomTip;
                habitTip.classList.add('show');

                // 10 ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    habitTip.classList.remove('show');
                }, 10000);
            }

            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    habitTip.classList.remove('show');
                }, { once: true });
            }
        }

        function updateStreakOnComplete() {
            const today = getDateString();
            const lastPlay = progress.lastPlayDate;
            if (lastPlay === today) return;
            const daysDiff = lastPlay ? getDaysDiff(lastPlay, today) : 999;
            if (daysDiff === 1) {
                progress.streak++;
            } else {
                progress.streak = 1;
            }
            progress.lastPlayDate = today;
        }

        // === æˆå°±ç³»çµ± ===
        function checkAchievements() {
            const newAchievements = [];
            ACHIEVEMENTS.forEach(ach => {
                if (progress.achievements.includes(ach.id)) return;
                let earned = false;
                if (ach.type === 'streak') {
                    earned = progress.streak >= ach.requirement;
                } else if (ach.type === 'total') {
                    earned = progress.totalGames >= ach.requirement;
                } else if (ach.type === 'moves') {
                    earned = moves <= ach.requirement;
                } else if (ach.type === 'time') {
                    earned = seconds <= ach.requirement;
                } else {
                    earned = progress.totalGames >= ach.requirement;
                }
                if (earned) {
                    progress.achievements.push(ach.id);
                    newAchievements.push(ach);
                }
            });
            if (newAchievements.length > 0) {
                showAchievementNotification(newAchievements[0]);
            }
        }

        function showAchievementNotification(ach) {
            playAchievementSound();
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            notification.innerHTML = `
                <div class="ach-icon">ğŸ†</div>
                <div class="ach-content">
                    <div class="ach-title">æˆå°±è§£é–ï¼š${ach.name}</div>
                    <div class="ach-desc">${ach.desc}</div>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // === æ›´æ–°çµ±è¨ˆé¡¯ç¤º ===
        function updateStatsDisplay() {
            const streakEl = document.getElementById('streakDisplay');
            const bestEl = document.getElementById('bestDisplay');
            if (streakEl) streakEl.textContent = progress.streak;
            if (bestEl) {
                if (progress.bestMoves === Infinity) {
                    bestEl.textContent = '-';
                } else {
                    bestEl.textContent = progress.bestMoves;
                }
            }
        }

        // æ´—ç‰Œå‡½æ•¸ (Fisher-Yates)
        function shuffle(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // åˆå§‹åŒ–éŠæˆ²
        function initGame() {
            // è¼‰å…¥é€²åº¦ï¼ˆé¦–æ¬¡åˆå§‹åŒ–æ™‚ï¼‰
            let wasStreakBroken = false;
            if (progress.totalGames === 0 && progress.achievements.length === 0) {
                loadProgress();
                wasStreakBroken = updateStreakOnLoad();
            }
            updateStatsDisplay();

            // å¦‚æœ Streak è¢«ä¸­æ–·ï¼Œå»¶é²é¡¯ç¤ºå®‰æ…°è¨Šæ¯
            if (wasStreakBroken) {
                setTimeout(() => {
                    showStreakBrokenMessage();
                }, 500);
            }

            // é‡ç½®ç‹€æ…‹
            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            moves = 0;
            gameStarted = false;
            isProcessing = false;
            seconds = 0;

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // æ›´æ–°é¡¯ç¤º
            movesDisplay.textContent = '0';
            matchesDisplay.textContent = '0 / 8';
            timerDisplay.textContent = '00:00';
            messageDisplay.textContent = 'ç¿»é–‹å¡ç‰‡ï¼Œæ‰¾å‡ºæˆå°çš„å…«æ­£é“';
            messageDisplay.className = 'message';

            // å»ºç«‹å¡ç‰‡é™£åˆ— (æ¯å€‹å…«æ­£é“å‡ºç¾å…©æ¬¡)
            const cardData = [...eightfoldPath, ...eightfoldPath];
            const shuffledCards = shuffle(cardData);

            // æ¸…ç©ºå®¹å™¨ä¸¦è¨­å®šæ ¼ç·š
            gameContainer.innerHTML = '';
            gameContainer.style.gridTemplateColumns = 'repeat(4, 1fr)';

            // å»ºç«‹å¡ç‰‡å…ƒç´ 
            shuffledCards.forEach((data, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.index = index;
                card.dataset.symbol = data.symbol;
                card.dataset.name = data.name;

                card.innerHTML = `
                    <div class="card-face card-back"></div>
                    <div class="card-face card-front">
                        <span class="card-symbol">${data.symbol}</span>
                        <span class="card-text">${data.name}</span>
                    </div>
                `;

                card.addEventListener('click', () => flipCard(card));
                gameContainer.appendChild(card);
                cards.push(card);
            });
        }

        // ç¿»ç‰Œ
        function flipCard(card) {
            // é˜²æ­¢é‡è¤‡é»æ“Šæˆ–è™•ç†ä¸­
            if (isProcessing) return;
            if (card.classList.contains('flipped')) return;
            if (card.classList.contains('matched')) return;
            if (flippedCards.length >= 2) return;

            // åˆå§‹åŒ–éŸ³æ•ˆï¼ˆéœ€ç”¨æˆ¶äº’å‹•ï¼‰
            initAudio();

            // é–‹å§‹è¨ˆæ™‚
            if (!gameStarted) {
                gameStarted = true;
                startTimer();
            }

            // ç¿»ç‰Œ
            playFlipSound();
            card.classList.add('flipped');
            flippedCards.push(card);

            // æª¢æŸ¥é…å°
            if (flippedCards.length === 2) {
                moves++;
                movesDisplay.textContent = moves;
                checkMatch();
            }
        }

        // æª¢æŸ¥é…å°
        function checkMatch() {
            isProcessing = true;
            const [card1, card2] = flippedCards;
            const isMatch = card1.dataset.symbol === card2.dataset.symbol;

            if (isMatch) {
                // é…å°æˆåŠŸ
                playMatchSound(matchedPairs);
                card1.classList.add('matched');
                card2.classList.add('matched');
                matchedPairs++;
                matchesDisplay.textContent = `${matchedPairs} / 8`;

                const matchedName = card1.dataset.name;
                messageDisplay.textContent = `âœ¨ ${matchedName} - é…å°æˆåŠŸï¼`;

                flippedCards = [];
                isProcessing = false;

                // æª¢æŸ¥éŠæˆ²çµæŸ
                if (matchedPairs === 8) {
                    endGame();
                }
            } else {
                // é…å°å¤±æ•—ï¼Œç¿»å›
                playMismatchSound();
                messageDisplay.textContent = 'ä¿æŒæ­£å¿µï¼Œå†è©¦ä¸€æ¬¡...';
                setTimeout(() => {
                    card1.classList.remove('flipped');
                    card2.classList.remove('flipped');
                    flippedCards = [];
                    isProcessing = false;
                }, 1000);
            }
        }

        // è¨ˆæ™‚å™¨
        function startTimer() {
            timerInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${mins}:${secs}`;
            }, 1000);
        }

        // éŠæˆ²çµæŸ
        function endGame() {
            clearInterval(timerInterval);
            playCompletionSound();

            // æ›´æ–°é€²åº¦çµ±è¨ˆ
            progress.totalGames++;
            if (moves < progress.bestMoves) {
                progress.bestMoves = moves;
            }
            if (seconds < progress.bestTime) {
                progress.bestTime = seconds;
            }

            // æ›´æ–°é€£çºŒå¤©æ•¸
            updateStreakOnComplete();

            // æª¢æŸ¥æˆå°±
            checkAchievements();

            // æ›´æ–°é¡¯ç¤º
            updateStatsDisplay();

            // å„²å­˜é€²åº¦
            saveProgress();

            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timeStr = mins > 0 ? `${mins}åˆ†${secs}ç§’` : `${secs}ç§’`;

            // é¡¯ç¤ºæ˜¯å¦ç ´ç´€éŒ„
            const isNewRecord = moves === progress.bestMoves || seconds === progress.bestTime;
            const recordText = isNewRecord ? ' ğŸ† æ–°ç´€éŒ„ï¼' : '';

            messageDisplay.className = 'message success';
            messageDisplay.textContent = `ğŸ‰ åœ“æ»¿å®Œæˆï¼ç”¨äº† ${moves} æ¬¡ç¿»ç‰Œï¼Œè€—æ™‚ ${timeStr}${recordText}`;

            // é¡¯ç¤ºçµ±è¨ˆèˆ‡é¼“å‹µè¨Šæ¯
            setTimeout(() => {
                const encouragements = [
                    'å…«æ­£é“å·²å…¥å¿ƒï¼Œé¡˜ä½ å¸¸ä¿æ­£å¿µã€‚',
                    'å°ˆæ³¨è¦ºå¯Ÿï¼Œæ™ºæ…§å¢é•·ã€‚',
                    'å¿ƒç„¡ç½£ç¤™ï¼Œè‡ªåœ¨è§£è„«ã€‚',
                    'ä¸€å¿µæ¸…æ·¨ï¼Œè¬æ³•æ­¸ä¸€ã€‚'
                ];
                const randomMsg = encouragements[Math.floor(Math.random() * encouragements.length)];
                messageDisplay.innerHTML = `ğŸ™ ${randomMsg}<br><span style="font-size: 0.9rem; color: #a0a0a0;">ç´¯è¨ˆ ${progress.totalGames} æ¬¡ | é€£çºŒ ${progress.streak} å¤© | æœ€ä½³ ${progress.bestMoves} æ¬¡</span>`;
            }, 3000);

            // é¡¯ç¤ºç¿’æ…£å †ç–Šå»ºè­°ï¼ˆç¿’æ…£å †ç–ŠåŸå‰‡ï¼šå¹«åŠ©ç”¨æˆ¶å»ºç«‹å›ºå®šæ™‚æ©Ÿï¼‰
            setTimeout(() => {
                showHabitStackTip();
            }, 5000);
        }

        // é‡æ–°é–‹å§‹æŒ‰éˆ•
        restartBtn.addEventListener('click', () => {
            initAudio();
            playFlipSound();
            initGame();
        });


        // === æš«åœåŠŸèƒ½ ===
        let isPaused = false;

        function togglePause() {
            if (!gameStarted || matchedPairs === 8) return;
            if (isPaused) {
                resumeGame();
            } else {
                pauseGame();
            }
        }

        function pauseGame() {
            isPaused = true;
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            const overlay = document.createElement('div');
            overlay.className = 'pause-overlay';
            overlay.id = 'pauseOverlay';
            overlay.innerHTML =
                '<h2>éŠæˆ²æš«åœ</h2>' +
                '<p>æŒ‰ Esc æˆ–é»æ“Šç¹¼çºŒ</p>' +
                '<button class="btn" id="resumePauseBtn">ç¹¼çºŒéŠæˆ²</button>';
            document.body.appendChild(overlay);
            document.getElementById('resumePauseBtn').addEventListener('click', resumeGame);
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) resumeGame();
            });
        }

        function resumeGame() {
            isPaused = false;
            const overlay = document.getElementById('pauseOverlay');
            if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
            if (gameStarted && matchedPairs < 8) {
                startTimer();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                e.preventDefault();
                togglePause();
            }
        });

        // åˆå§‹åŒ–
        initGame();
    </script>
</body>
</html>
